name: 构建并部署 Spring Boot 应用

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, ARM64]

    steps:
      # 1️⃣ 拉取最新代码（改用 SSH，需预先在 secrets 配置 REPO_SSH_KEY）
      - name: 拉取代码（SSH）
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.REPO_SSH_KEY }}
          fetch-depth: 1
          persist-credentials: false

      # 2️⃣ 设置 JDK 17
      - name: 设置 JDK 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3️⃣ 赋予 mvnw 可执行权限
      - name: 赋予 mvnw 可执行权限
        run: chmod +x mvnw

      # 4️⃣ 构建 Spring Boot 项目（提前失败快，镜像内仍会再构建一次）
      - name: 构建项目
        run: ./mvnw clean package -DskipTests -B -q

      # 5️⃣ 写入部署所需的 .env（使用 secrets，请预先在仓库/环境配置 REDIS_PASSWORD）
      - name: 生成部署环境变量文件
        shell: bash
        run: |
          set -euo pipefail
          cat > .env <<'EOF'
          SPRING_APPLICATION_NAME=hello
          SPRING_DATA_REDIS_HOST=redis
          SPRING_DATA_REDIS_PORT=6379
          SPRING_DATA_REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SPRING_DATA_REDIS_TIMEOUT=2s
          SERVER_PORT=8080
          SERVER_ADDRESS=0.0.0.0
          EOF

      # 6️⃣ 使用 docker compose 构建镜像并启动（app + redis）
      - name: 使用 docker compose 部署
        shell: bash
        run: |
          set -euo pipefail
          docker compose -f compose.yml down --remove-orphans
          docker compose -f compose.yml build app
          docker compose -f compose.yml up -d

          # 展示状态
          docker compose -f compose.yml ps
