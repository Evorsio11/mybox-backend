name: 构建并部署 Spring Boot 应用

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, ARM64]
    environment: prod

    steps:
      # 1️⃣ 拉取最新代码（改用 SSH，需预先在 secrets 配置 REPO_SSH_KEY）
      - name: 拉取代码（SSH）
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.REPO_SSH_KEY }}
          fetch-depth: 1
          persist-credentials: false

      # 2️⃣ 设置 JDK 17
      - name: 设置 JDK 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3️⃣ 赋予 mvnw 可执行权限
      - name: 赋予 mvnw 可执行权限
        run: chmod +x mvnw

      # 4️⃣ 构建 Spring Boot 项目（提前失败快，镜像内仍会再构建一次）
      - name: 构建项目
        run: ./mvnw clean package -DskipTests -B -q

      # 5️⃣ 生成 .env（值来自 Environment Vars/Secrets）
      - name: 生成部署环境变量文件
        shell: bash
        run: |
          set -euo pipefail
          cat > .env <<EOF
          SPRING_APPLICATION_NAME=${{ vars.SPRING_APPLICATION_NAME }}
          SPRING_PROFILES_ACTIVE=${{ vars.SPRING_PROFILES_ACTIVE }}
          SPRING_DATA_REDIS_HOST=${{ vars.SPRING_DATA_REDIS_HOST }}
          SPRING_DATA_REDIS_PORT=${{ vars.SPRING_DATA_REDIS_PORT }}
          SPRING_DATA_REDIS_TIMEOUT=${{ vars.SPRING_DATA_REDIS_TIMEOUT }}
          SERVER_PORT=${{ vars.SERVER_PORT }}
          SERVER_ADDRESS=${{ vars.SERVER_ADDRESS }}
          SPRING_DATA_REDIS_PASSWORD=${{ secrets.PROD_REDIS_PASSWORD }}
          EOF

      # 6️⃣ 使用 docker compose 构建镜像并启动（app + redis）
      - name: 使用 docker compose 部署
        shell: bash
        run: |
          set -euo pipefail
          if docker compose version >/dev/null 2>&1; then
            COMPOSE="docker compose"
          elif docker-compose version >/dev/null 2>&1; then
            COMPOSE="docker-compose"
          else
            echo "docker compose 未安装，请在 runner 上安装 Compose v2 插件或 docker-compose" >&2
            exit 1
          fi

          $COMPOSE -f compose.yml down --remove-orphans
          $COMPOSE -f compose.yml build app
          $COMPOSE -f compose.yml up -d

          # 展示状态
          $COMPOSE -f compose.yml ps
