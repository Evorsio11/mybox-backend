# File 模块问题清单

> **应用定位**：个人云盘应用 - 用户上传个人文件，跨设备访问
>
> **核心关注**：上传、下载、删除、列表等基础功能的稳定性和数据一致性

## 已修复 ✅
- 文件类型校验（扩展名和MIME类型）
- 文件去重（SHA-256 hash）
- 上传失败MinIO回滚
- 文件名URL编码（下载）
- FileUploadProperties配置类

---

## 目录
- [1. 文件上传问题](#1-文件上传问题)
- [2. 文件下载问题](#2-文件下载问题)
- [3. 文件删除问题](#3-文件删除问题)
- [4. 文件列表问题](#4-文件列表问题)
- [5. 文件恢复问题](#5-文件恢复问题)
- [6. 数据一致性问题](#6-数据一致性问题)
- [7. 安全问题](#7-安全问题)
- [8. 性能问题](#8-性能问题)

---

## 1. 文件上传问题

### 1.1 文件大小限制未实现
**位置**: `FileServiceImpl.java:38-101`

**问题**:
- FileUploadProperties配置类已创建但未使用
- 没有校验文件大小，可能导致存储空间被耗尽

**影响**: 用户可能上传超大文件占用所有存储空间

---

### 1.2 文件名安全处理不足
**位置**: `FileServiceImpl.java:79`

**问题**:
- 只校验了扩展名，文件名本身未做清理
- 可能包含路径遍历字符（如`../../`）或控制字符

**影响**: 安全风险，可能被利用进行路径遍历攻击

---

### 1.3 未实现分片上传
**位置**: `FileStatus.java:24-29`, `MinioStorageService.java:13`

**问题**:
- MinioStorageService定义了uploadMultipart方法但未实现
- 大文件上传失败需重新上传整个文件
- 网络不稳定时用户体验差

**影响**: 大文件上传体验差，浪费带宽

---

### 1.4 异常处理不统一
**位置**: `FileServiceImpl.java:99`

**问题**:
- 上传失败使用RuntimeException而非FileException
- 异常处理不一致

**影响**: 错误信息不清晰，难以定位问题

---

## 2. 文件下载问题

### 2.1 缺少Range支持
**位置**: `FileController.java:63-80`

**问题**:
- 不支持断点续传
- 大文件下载失败需重新开始
- 视频/音频无法分段加载

**影响**: 大文件下载体验差，带宽浪费

---

### 2.2 下载时无流量控制
**位置**: `FileController.java:63-80`

**问题**:
- 没有速率限制
- 单个用户可能耗尽所有带宽

**影响**: 可能影响其他用户访问

---

## 3. 文件删除问题

### 3.1 删除失败状态不一致
**位置**: `FileServiceImpl.java:125-137`

**问题**:
- MinIO删除成功但数据库更新可能失败
- 导致MinIO已删但数据库仍为ACTIVE

**影响**: 数据不一致，文件已删但列表仍显示

---

### 3.2 缺少自动清理机制
**位置**: `FileServiceImpl.java:125-137`

**问题**:
- 软删除的文件（DELETED状态）MinIO对象仍存在
- 没有定时任务清理这些文件
- 浪费存储空间

**影响**: DELETED文件占用存储空间，长期累积导致空间浪费

---

### 3.3 无批量操作
**位置**: `FileController.java`

**问题**:
- 一次只能删除/恢复一个文件
- 批量操作需多次请求

**影响**: 用户体验差

---

## 4. 文件列表问题

### 4.1 无分页支持
**位置**: `FileServiceImpl.java:140-142`, `FileRepository.java:14`

**问题**:
- 返回所有记录，不使用分页
- 文件多时可能内存溢出
- 响应时间长

**影响**: 文件多时性能差，可能OOM

---

### 4.2 无排序和搜索功能
**位置**: `FileController.java:96-100`

**问题**:
- 不能按名称、大小、时间排序
- 不能按文件名搜索

**影响**: 文件多时难以查找

---

### 4.3 无存储统计
**位置**: `FileController.java`

**问题**:
- 无法获取文件总数和总大小
- 无法显示存储使用情况

**影响**: 用户无法了解存储空间使用情况

---

### 4.4 缺少数据库索引
**位置**: `File.java:20`

**问题**:
- 没有为常用查询字段添加索引
- 可能全表扫描

**影响**: 查询性能差

---

## 5. 文件恢复问题

### 5.1 恢复时不检查文件存在性
**位置**: `FileServiceImpl.java:150-159`

**问题**:
- 恢复时不检查MinIO对象是否存在
- 可能恢复一个无法下载的文件

**影响**: 恢复的文件无法下载，用户体验差

---

## 6. 数据一致性问题

### 6.1 跨系统事务缺失
**位置**: `FileServiceImpl.java:38-101`

**问题**:
- 数据库和MinIO操作没有原子性保证
- 虽然有回滚机制，但去重时删除刚上传的对象可能导致不一致

**影响**: 在高并发或异常情况下可能出现数据不一致

---

### 6.2 缺少定期对账
**位置**: 整个模块

**问题**:
- 没有定期检查数据库记录与MinIO对象的一致性
- 可能存在孤儿文件或空记录

**影响**: 长期运行后数据不一致

---

## 7. 安全问题

### 7.1 认证方式不安全
**位置**: `FileController.java:39`

**问题**:
- `authentication.getDetails().toString()`获取userId不正规
- 应该使用principal或自定义UserDetails

**影响**: 可能存在安全隐患

---

### 7.2 无速率限制
**位置**: `FileController.java`

**问题**:
- 上传/下载接口没有防刷机制
- 可能被滥用

**影响**: 服务可能被恶意攻击

---

### 7.3 文件类型验证不完整
**位置**: `FileServiceImpl.java:45-54`

**问题**:
- 只检查扩展名和MIME类型声明
- 不检查文件内容真实类型（magic bytes）
- 可能上传伪装文件（如.exe改为.jpg）

**影响**: 安全风险

---

## 8. 性能问题

### 8.1 无并发控制
**位置**: `FileServiceImpl.java`

**问题**:
- 大文件上传/下载没有并发限制
- 可能耗尽服务器资源

**影响**: 高并发时性能差，可能崩溃

---

### 8.2 下载总是经过服务器中转
**位置**: `FileController.java:63-80`

**问题**:
- 下载总是经过应用服务器
- 无法直接从MinIO下载
- 服务器带宽压力大

**影响**: 服务器带宽成为瓶颈，成本高

---

### 8.3 流式处理无缓冲控制
**位置**: `MinioStorageServiceImpl.java:16-31`

**问题**:
- 流式处理没有缓冲区大小控制
- 大文件可能导致OOM

**影响**: 内存占用高，可能OOM

---

## 优先级建议

### P0 - 严重问题（立即修复）
1. 文件大小限制未实现 (1.1)
2. 删除失败状态不一致 (3.1)
3. 无分页支持 (4.1)
4. 缺少数据库索引 (4.4)
5. 恢复时不检查文件存在性 (5.1)
6. MinioStorageService.uploadMultipart未实现 (1.3)

### P1 - 重要问题（尽快修复）
1. 文件名安全处理不足 (1.2)
2. 缺少自动清理机制 (3.2)
3. 无排序和搜索功能 (4.2)
4. 无存储统计 (4.3)
5. 异常处理不统一 (1.4)

### P2 - 性能优化（计划修复）
1. 缺少Range支持 (2.1)
2. 无并发控制 (8.1)
3. 下载总是经过服务器中转 (8.2)
4. 无速率限制 (7.2)
5. 缺少定期对账 (6.2)

### P3 - 安全增强（有时间再做）
1. 认证方式不安全 (7.1)
2. 文件类型验证不完整 (7.3)

---

## 修复建议

### 第一阶段：核心功能稳定
- 实现文件大小限制
- 修复删除操作的状态不一致
- 实现分页功能
- 添加数据库索引
- 实现恢复时的存在性检查
- 修复MinioStorageService未实现方法

### 第二阶段：用户体验
- 完善文件名安全处理
- 实现自动清理DELETED文件
- 添加排序和搜索功能
- 添加存储统计
- 统一异常处理

### 第三阶段：性能优化
- 实现Range支持（断点续传）
- 添加并发控制
- 实现预签名URL
- 添加速率限制
- 实现定期对账

### 第四阶段：安全加固
- 改进认证方式
- 完善文件类型验证

---

## 测试建议

### 核心功能测试
- 上传：各种文件类型、大小限制、去重
- 下载：断点续传、文件名编码
- 删除：软删除、恢复、清理
- 列表：分页、排序、搜索

### 异常场景测试
- 网络中断
- MinIO不可用
- 数据库连接失败
- 并发上传/下载

### 性能测试
- 大文件上传/下载
- 大量文件列表查询
- 高并发场景

### 安全测试
- 文件类型伪造
- 路径遍历攻击
- 越权访问

---

## 总结

### 当前状态
✅ **已实现**：
- 基础文件CRUD
- 文件类型和去重校验
- 上传失败回滚
- 用户隔离（ownerId）

### 核心问题
❌ **亟需解决**：
1. **功能完整性**：文件大小限制、分页、搜索
2. **数据一致性**：删除失败处理、恢复校验
3. **性能**：无分页、缺少索引、无并发控制
4. **安全性**：文件名处理、认证方式

### 建议
根据个人云盘的定位，建议**优先修复P0和P1问题**，这些直接影响用户体验和系统稳定性。P2和P3可以在后续迭代中优化。
